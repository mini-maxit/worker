name: Run tests and upload coverage

on:
  push:
    branches:
      - master


jobs:
  test:
    name: Run tests and collect coverage
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:dind
        options: >-
          --privileged
          --health-cmd="docker ps"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Install dependencies
        run: go mod download

      - name: Run unit tests with coverage
        run: go test -coverprofile=coverage-unit.txt -covermode=atomic ./...

      - name: Run integration tests with coverage
        env:
          DOCKER_HOST: unix:///var/run/docker.sock
        run: go test -tags=integration -coverprofile=coverage-integration.txt -covermode=atomic ./...

      - name: Merge coverage reports
        run: |
          go install github.com/wadey/gocovmerge@latest
          gocovmerge coverage-unit.txt coverage-integration.txt > coverage.txt

      - name: Upload results to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.txt
          fail_ci_if_error: true
