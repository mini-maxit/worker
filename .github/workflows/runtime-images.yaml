name: Runtime Images

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAMESPACE: ${{ github.repository_owner }}

jobs:
  build-and-push-runtime:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Semantic version
        id: version
        uses: PaulHatch/semantic-version@v5.4.0
        with:
          major_pattern: '/^feat!/'
          minor_pattern: '/^feat/'
          bump_each_commit: true
          bump_each_commit_patch_pattern: '/^fix/'

      - name: Docker Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare runtime folders
        run: |
          for folder in $(find internal/stages/executor -type d -mindepth 1 -maxdepth 1); do
            cp internal/stages/executor/run_tests.sh "$folder/run_tests.sh"
          done

      - name: Build and push runtime images
        env:
          RUNTIME_TAG: ${{ steps.version.outputs.version }}
          IS_DEFAULT_BRANCH: ${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}
        run: |
          for folder in $(find internal/stages/executor -type d -mindepth 1 -maxdepth 1); do
            folder_name=$(basename "$folder")

            # Special handling for Python - build multiple versions
            if [ "$folder_name" = "python" ]; then
              for version in 3.10 3.11 3.12; do
                tags="--tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/runtime-$folder_name-${version}"
                if [ "$IS_DEFAULT_BRANCH" = "true" ]; then
                  tags="$tags --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/runtime-$folder_name-${version}:${RUNTIME_TAG} --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/runtime-$folder_name-${version}:latest"
                fi
                docker buildx build \
                  --push \
                  --platform linux/amd64,linux/arm64 \
                  --build-arg PYTHON_VERSION=${version} \
                  $tags \
                  "$folder"
              done
            else
              # For non-Python languages, build single image
              tags="--tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/runtime-$folder_name:${RUNTIME_TAG}"
              if [ "$IS_DEFAULT_BRANCH" = "true" ]; then
                tags="$tags --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/runtime-$folder_name:latest"
              fi
              docker buildx build \
                --push \
                --platform linux/amd64,linux/arm64 \
                $tags \
                "$folder"
            fi
          done
